<template>
  <view wx:if="{{ show }}" class="voice_indicator" bind:longpress="handleLongPressVoice"
    bind:touchmove="handleTouchMove" bind:touchend="handleTouchEnd" bind:touchcancel="handleTouchCancel">
    按住说话
  </view>
  <view wx:if="{{ showVoiceInput }}" class="voice-input recording">
    <view class="wave">
      <view class="wave-container">
        <view class="wave-bar" wx:for="{{ waveBarsActive }}" wx:key="index"
          style="height: {{item}}%; animation-delay: {{index * 0.05}}s;"></view>
      </view>
    </view>

    <view class="bottom-buttons" wx:if="{{ listening }}">
      <view class="cancel"
        style="{{ currentTouchArea === TouchArea.CANCEL ? 'background: #FF4040' : 'background: #666' }}">
        {{ cancelBtnText }}</view>
      <view class="speak">{{ speakBtnText }}</view>
    </view>
  </view>
</template>

<script lang="ts">
import { checkRecordPermission, getErrorMessage, isPointInArea } from "@/utils/voice";
import { createComponent, PropType } from "@mpxjs/core"

const plugin = requirePlugin("WechatSI");
let manager = plugin.getRecordRecognitionManager();

enum TouchArea {
  CANCEL = 'cancel',
  SPEAK = 'speak',
  OTHER = 'other'
}

createComponent({
  properties: {
    show: {
      type: Boolean,
      value: false
    },
    language: {
      type: String as PropType<'zh_CN' | 'en_US' | 'zh_HK' | 'sichuanhua'>,
      value: 'zh_CN'
    },
    maxDuration: {
      type: Number,
      value: 10000
    },
    minDuration: {
      type: Number,
      value: 500
    },
  },

  data: {
    waveBarsActive: [50, 80, 65, 95, 45, 85, 70, 55, 80, 60, 75, 90, 50, 80, 65],
    waveBarsSilence: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    listening: false,
    touchStartTime: 0,
    recordingTime: 0, // 录音时长（秒）
    recordingTimer: null as any, // 录音计时器
    showVoiceInput: false,
    cancelButtonRect: null as any, // 取消按钮的位置信息
    speakButtonRect: null as any, // 说话按钮的位置信息
    // 手指移动到的区域
    currentTouchArea: TouchArea.OTHER,
    TouchArea,
    // 录音识别结果
    recogniResult: '',
  },
  computed: {
    cancelBtnText() {
      return this.currentTouchArea === TouchArea.CANCEL ? '松开取消' : '取消'
    },
    speakBtnText() {
      return this.currentTouchArea === TouchArea.CANCEL ? '按住说话' : '松开发送'
    },
  },
  watch: {
    showVoiceInput: {
      handler(show: boolean) {
        if (show) {
          this.startRecording();
          this.getButtonRects();
        }
      },
      immediate: true
    }
  },
  attached() {
    this.recordHandler();
  },

  methods: {
    /**
     * 录音管理器回调
     */
    recordHandler() {
      console.log('初始化录音管理器回调')
      manager.onStart = (res: any) => {
        this.startRecordingTimer();
      };

      manager.onStop = (res: any) => {
        console.log('onStop: ', new Date().toLocaleTimeString());
        const result = res.result || '';
        this.setData({
          listening: false,
          recogniResult: result,
          showVoiceInput: false
        });
        if (this.data.currentTouchArea === TouchArea.CANCEL) {
          console.log('cancel')
          this.emitResult('', true);
        } else {
          console.log('speak')
          if (result.length <= 0) {
            wx.showToast({
              title: '请说话',
              icon: "none",
              duration: 2000
            });
          }
          this.emitResult(result, false);
        }
      };

      manager.onError = ({ retcode, msg }: { retcode: number, msg: string }) => {
        const errorMessage = getErrorMessage(retcode);
        this.setData({
          listening: false,
        });
        this.emitResult('', false);
        this.stopRecordingTimer();
      };
    },
    /**
     * 长按说话
     */
    async handleLongPressVoice() {
      const hasPermission = await checkRecordPermission();
      if (!hasPermission) {
        return;
      }
      wx.vibrateShort({
        type: "medium"
      });

      this.setData({
        showVoiceInput: true,
        currentTouchArea: TouchArea.SPEAK,
      });
    },

    // 获取按钮位置信息
    getButtonRects() {
      const cancelQuery = this.createSelectorQuery();
      cancelQuery.select('.cancel').boundingClientRect();

      const speakQuery = this.createSelectorQuery();
      speakQuery.select('.speak').boundingClientRect();

      cancelQuery.exec((cancelRes: any) => {
        if (cancelRes && cancelRes[0]) {
          this.setData({
            cancelButtonRect: cancelRes[0]
          });
        }
      });
      speakQuery.exec((speakRes: any) => {
        if (speakRes && speakRes[0]) {
          this.setData({
            speakButtonRect: speakRes[0]
          });
        }
      });
    },

    /**
     * 触摸移动
     * @param e
     */
    handleTouchMove(e: any) {
      if (!this.data.showVoiceInput && this.data.listening) return;

      const touch = e.touches[0];
      const touchX = touch.clientX;
      const touchY = touch.clientY;

      // 检查是否移动到取消按钮
      if (isPointInArea(touchX, touchY, this.data.cancelButtonRect)) {
        if (this.data.currentTouchArea === TouchArea.CANCEL) return;
        wx.vibrateShort({
          type: "medium",
        });
        this.setData({
          currentTouchArea: TouchArea.CANCEL,
        });
        return;
      }

      // 检查是否移动到说话按钮
      if (isPointInArea(touchX, touchY, this.data.speakButtonRect)) {
        if (this.data.currentTouchArea === TouchArea.SPEAK) return;
        wx.vibrateShort({
          type: "medium",
        });
        this.setData({
          currentTouchArea: TouchArea.SPEAK,
        });
        return;
      }

      this.setData({
        currentTouchArea: TouchArea.OTHER,
      });
    },

    /**
     * 触摸结束
     * @param e
     */
    handleTouchEnd(e: any) {
      this.stopRecording();
    },

    /**
     * 触摸取消。手指触摸动作被打断，如弹窗和来电提醒
     */
    handleTouchCancel() {
      this.stopRecording();
    },

    /**
     * 开始录音
     */
    startRecording() {
      if (this.data.listening) return;
      manager.start({
        duration: this.data.maxDuration,
        lang: this.data.language,
        detectInterrupt: true
      })
      this.setData({
        listening: true,
        recogniResult: '',
        touchStartTime: Date.now(),
        recordingTime: 0,
      });
    },

    /**
     * 停止录音
     */
    stopRecording() {
      if (manager) {
        console.log('stopRecording: ', new Date().toLocaleTimeString());
        manager.stop();
      }
      this.setData({
        listening: false,
      });
      this.stopRecordingTimer();
    },

    /**
     * 停止录音计时
     */
    stopRecordingTimer() {
      if (this.data.recordingTimer) {
        clearInterval(this.data.recordingTimer);
        this.setData({
          recordingTimer: null
        });
      }
    },

    /**
     * 开始录音计时
     */
    startRecordingTimer() {
      this.data.recordingTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - this.data.touchStartTime) / 1000);
        this.setData({
          recordingTime: elapsed
        });
      }, 1000);
    },

    /**
     * 发送录音结果
     * @param result
     * @param isCancelled
     */
    emitResult(result: string, isCancelled: boolean) {
      wx.vibrateShort({
        type: "medium"
      });
      this.triggerEvent('voiceResult', {
        result,
        isCancelled: isCancelled
      });
      this.setData({
        showVoiceInput: false,
      });
    }
  },
});
</script>

<style>
.voice_indicator {
  height: 68rpx;
  background-color: #0a0a0a;
  border-radius: 24rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
}

.voice-input {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100vw;
  height: 100vh;
  background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, transparent 100%);
  z-index: 9999;
  padding: 60rpx 0;
  box-sizing: border-box;
}

.wave {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 254rpx;
  height: 92rpx;
  background-color: #FADA39;
  border-radius: 23rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 20rpx;
  box-sizing: border-box;
  flex-direction: column;
}

.wave-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  height: 40rpx;
  gap: 2rpx;
}

.wave-bar {
  background-color: #000;
  border-radius: 1rpx;
  animation: waveAnimation 1.5s ease-in-out infinite;
  min-height: 8rpx;
  width: 4rpx;
}

.wave-text {
  font-size: 14px;
  color: #000;
  text-align: center;
  line-height: 1.4;
  word-wrap: break-word;
}

.wave-text .dot {
  display: inline-block;
  animation: dotFade 1.5s infinite;
}

.wave-text .dot1 {
  animation-name: dotFade1;
}

.wave-text .dot2 {
  animation-name: dotFade2;
}

.wave-text .dot3 {
  animation-name: dotFade3;
}

@keyframes dotFade1 {

  0%,
  100% {
    opacity: 1;
  }
}

@keyframes dotFade2 {

  0%,
  33% {
    opacity: 0;
  }

  34%,
  100% {
    opacity: 1;
  }
}

@keyframes dotFade3 {

  0%,
  66% {
    opacity: 0;
  }

  67%,
  100% {
    opacity: 1;
  }
}

/* 录音时的增强动画 */
.voice-input.recording .wave-bar {
  animation: recordingWaveAnimation 0.8s ease-in-out infinite;
}

@keyframes waveAnimation {

  0%,
  100% {
    transform: scaleY(0.3);
  }

  50% {
    transform: scaleY(1);
  }
}

@keyframes recordingWaveAnimation {

  0%,
  100% {
    transform: scaleY(0.2);
  }

  25% {
    transform: scaleY(0.8);
  }

  50% {
    transform: scaleY(1.2);
  }

  75% {
    transform: scaleY(0.6);
  }
}

/* 文字显示区域 */
.text-display {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, 50%);
  width: 500rpx;
  min-height: 80rpx;
  background-color: rgba(0, 0, 0, 0.6);
  border-radius: 20rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20rpx;
  box-sizing: border-box;
}

.text-content {
  color: #fff;
  font-size: 28rpx;
  text-align: center;
  line-height: 1.4;
  word-wrap: break-word;
}

/* 错误状态样式 */
.voice-input.error .text-display {
  background-color: rgba(255, 0, 0, 0.3);
  border: 2rpx solid #ff4444;
}

.voice-input.error .text-content {
  color: #ff6666;
}

.recording-time {
  color: #FADA39;
  font-size: 24rpx;
  font-weight: bold;
  margin-top: 10rpx;
  display: block;
}

.bottom-buttons {
  position: absolute;
  bottom: 60rpx;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 80rpx;
}

.cancel {
  width: 160rpx;
  height: 160rpx;
  border-radius: 80rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 14px;
}

.speak {
  width: 630rpx;
  height: 92rpx;
  background-color: #666;
  border-radius: 24rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 14px;
  transition: all 0.2s ease;
  user-select: none;
}

.speak:active {
  background-color: #555;
  transform: scale(0.98);
}

.cancel {
  width: 160rpx;
  height: 160rpx;
  border-radius: 80rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 14px;
  transition: all 0.2s ease;
  user-select: none;
}

.cancel:active {
  background-color: #555;
  transform: scale(0.95);
}
</style>
